#!/bin/bash
#
# Run the abstraction refinement loop.
#
# Igor Konnov, 2012-2013

if [ "$#" -lt 2 ]; then
    echo "Not enough arguments"
    echo ""
    echo "Use: cegar promela_system property"
    exit 1
fi

trap "exit" SIGHUP SIGINT SIGTERM

PROG=$1
PROP=$2
BYMC_HOME=`dirname $0`
CEX="cex.trace"
MC_OUT="mc.out"

# interpret the functions specific to model checker
if [ "${TARGET_MC}" == "spin" ]; then
    . "${BYMC_HOME}/mod-verify-spin.sh"
elif [ "${TARGET_MC}" == "nusmv-bmc" ]; then
    . "${BYMC_HOME}/mod-verify-nusmv-bmc.sh"
else
    echo "Unsupported TARGET_MC='${TARGET_MC}'"
    exit 2
fi

cmd=""
step="0"
rand=""
out=""

START_TIME=0

function report_and_quit {
    echo "$1" 1>&2
    exit 1
}

function to_verdict() {
    if [ "$out" == "" ]; then
        out="|00:exitcode=quit|01:valid=maybe|02:spurious=maybe"
    fi

    END_TIME=$(date +%s)
    DIFF_TIME=$(($END_TIME-$START_TIME))

    mc_collect_stat
    common="|03:refinements=$step|04:sys=`basename $PROG .pml`|05:spec=`basename $PROP .never`|06:total-sec=$DIFF_TIME"
    echo "$out|$common|$mc_stat" >>verdict.txt
}

trap "to_verdict" ERR EXIT

CUR_DIR=`pwd`
cd $BYMC_HOME
if [ -d "src" ]; then
    # source distribution, compile the latest version
    if [ "x$DEBUG" == "x" ]; then
        ./make.sh || (cd $CUR_DIR; exit 1)
        TOOL="$BYMC_HOME/bymc.native ${BYMC_FLAGS} "
    else
        BYTE="1" ./make.sh || (cd $CUR_DIR; exit 1)
        TOOL="ocamldebug $BYMC_HOME/bymc.byte "
    fi
else
    # binary distribution
    TOOL="$BYMC_HOME/bymc.native ${BYMC_FLAGS} "
fi

cd $CUR_DIR

START_TIME=$(date +%s)

if [ "$CONTINUE" == "" ]; then
    # first run: no refinement, generate the initial abstraction
    mc_compile_first
fi

rm -rf ${MC_OUT} ${CEX} refinement.out

while [ "$cmd" != "q" ]; do
    mc_verify_spec

    if [ "$?" == "0" ]; then
        echo "The property is verified in $step refinement steps"
        out="|00:exitcode=ok|01:valid=yes|02:spurious=no"
        cmd="q"
    else
        mc_refine
        
        if grep "trace-no-refinement" refinement.out; then
            if [ "$AUTO" == "" ]; then
                echo "Enter to try another trace, q<Enter> to exit"
                rand="-DT_RAND"
                read cmd
            else
                cmd="q"
            fi
        elif grep "error" refinement.out \
                || grep "trace-concrete-example" refinement.out; then
            echo "It took $step refinement steps"
            out="|00:exitcode=ok|01:valid=no|02:spurious=no"
            cmd="q"
        elif grep "trace-refined" refinement.out; then
            step=$((step+1))
            if [ "$DEBUG" != "" -o "$ASK" != "" ]; then
                echo "Enter to continue, q<Enter> to exit"
                read cmd
            fi
        else
            echo "Unknown refinement status. Aborted."
            cmd="q"
        fi
    fi
done

# here to_verdict fires

